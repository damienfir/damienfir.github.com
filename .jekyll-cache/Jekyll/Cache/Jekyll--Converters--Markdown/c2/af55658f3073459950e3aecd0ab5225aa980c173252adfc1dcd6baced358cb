I"Ë<h3 id="decoding-lytro-files">Decoding Lytro files</h3>

<p><em>Information given here were first published by <a href="http://eclecti.cc/computervision/reverse-engineering-the-lytro-lfp-file-format">Nirav Patel</a>.</em></p>

<p>Most of the metadata needed to decode a raw Lytro image is included in the <code class="language-plaintext highlighter-rouge">.lfp</code> container that is obtainable by exporting the image from the Lytro desktop software.</p>

<p>Using <code class="language-plaintext highlighter-rouge">lfpsplitter</code> from <a href="https://github.com/nrpatel/lfptools">lfptools</a> on the exported <code class="language-plaintext highlighter-rouge">.lfp</code> file, you get 3 files:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">{filename}_imageRef0.raw</code></li>
  <li><code class="language-plaintext highlighter-rouge">{filename}_metadataRef0.json</code></li>
  <li><code class="language-plaintext highlighter-rouge">{filename}_table.json</code></li>
</ul>

<p>The first file is the raw data. Given that the raw size of a Lytro image is 3280x3280, you can decode it to a TIFF format by using <code class="language-plaintext highlighter-rouge">raw2tiff</code> as follows:</p>

<p><code class="language-plaintext highlighter-rouge">raw2tiff -w 3280 -l 3280 -d short input.raw output.tif</code></p>

<p>The second file contains metadata from the image. It includes information about the Bayer color filter pattern, the focal length and zoom position of the main lens, the calibration data related to the micro lens array such as offset and rotation, and other metadata about various components of the camera.</p>

<p>The third file contains information about the device and the two previous files.</p>

<h3 id="calibration-data">Calibration data</h3>

<p>Most calibration data is included in the <code class="language-plaintext highlighter-rouge">{filename}_metadataRef0.json</code> file but not all. Some extra data are contained in the backup files that the Lytro desktop software imports when the camera is first connected to the computer. Those files are usually found in <code class="language-plaintext highlighter-rouge">/Users/{username}/AppData/Local/Lytro</code> under the name <code class="language-plaintext highlighter-rouge">data.C.#</code>.</p>

<p>Those files can be decoded using <code class="language-plaintext highlighter-rouge">lfpsplitter</code> or <a href="http://code.behnam.es/python-lfp-reader/">python-lfp-reader</a> (I recommend the latter for this part, as the output filenames are clearer). The interesting file in the list is called <code class="language-plaintext highlighter-rouge">data.C.3.__C__T1CALIB__MLACALIBRATION.TXT</code> and contains calibration data for the micro lens array as a function of zoom and focus motor positions.</p>

<p>The most interesting of those numbers are the coordinates of the center of the central micro lens (<code class="language-plaintext highlighter-rouge">xDiskOriginPixels</code> and <code class="language-plaintext highlighter-rouge">yDiskOriginPixels</code>) and the components of the two vectors forming the basis of the hexagonal lattice on which the micro lenses are positioned (<code class="language-plaintext highlighter-rouge">xDiskStepPixelsX</code> and <code class="language-plaintext highlighter-rouge">xDiskStepPixelsY</code> for the first vector, and <code class="language-plaintext highlighter-rouge">yDiskStepPixelsX</code> and <code class="language-plaintext highlighter-rouge">yDiskStepPixelsY</code> for the second).</p>

<h3 id="extracting-the-light-field-from-the-raw-image">Extracting the light field from the raw image</h3>

<p>Given that micro lens sampling grid is hexagonal, we cannot sampling the light field using a orthogonal grid as it would be done for a conventional image. Instead we need to use the metadata extracted earlier to build a hexagonal grid.</p>

<p>The first step is to find the centers of every micro image (which are the images of each micro lens on the sensor). The coordinates for the center of the image extracted earlier gives the origin of the hexagonal lattice. From that point, all we have to use are the basis vectors. We can get the centers of each micro image by bulding the grid from those basis vectors, with coordinates that cover the whole image.</p>

<p>Once we extract the centers of each micro image, we can directly build a 11x11 grid (from -5 to +5 for x and y directions) for each of them, which will give us the relative coordinates of each pixel within each micro image.</p>
:ET